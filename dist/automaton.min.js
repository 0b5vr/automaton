"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}(),el=function(e,t,n){var i=null;i="string"==typeof e?document.createElement(e):e;for(var a in t)i.style[a]=t[a];return n&&n.appendChild(i),i},MODE_LINEAR=0,MODE_SMOOTH=1,MODE_EXP=2,MODE_SPRING=3,AutomatonParam=function(){function e(t){_classCallCheck(this,e);var n=this;n.automaton=t,n.values=[];for(var i=0;i<n.automaton.resolution+1;i++)n.values[i]=0;n.nodes=[];var a=(n.addNode(0,0),n.addNode(n.automaton.length,.75));a.mode=MODE_SPRING,a.params.rate=2e3,a.params.damp=1,n.render()}return _createClass(e,[{key:"sortNodes",value:function(){var e=this;e.nodes.sort(function(e,t){return e.time-t.time})}},{key:"render",value:function(e){for(var t=this,n=1;n<t.nodes.length;n++){var i=t.nodes[n-1].time,a=Math.floor(i*t.automaton.resolution),o=1===n||t.nodes[n].mods.reset,r=o?t.nodes[n-1].value:t.values[a],m=t.nodes[n].time,l=Math.floor(m*t.automaton.resolution),d=t.nodes[n].value;if(t.nodes[n].mode===MODE_LINEAR)for(var u=0;l-a+1>u;u++){var s=a+u,c=(s-a)/(l-a),p=r+(d-r)*c;t.values[s]=p}else if(t.nodes[n].mode===MODE_SMOOTH)for(var v=0;l-a+1>v;v++){var h=a+v,f=(h-a)/(l-a),g=f*f*(3-2*f),x=r+(d-r)*g;t.values[h]=x}else if(t.nodes[n].mode===MODE_EXP)for(var b=0;l-a+1>b;b++){var N=a+b,C=(N-a)/t.automaton.resolution,w=1-Math.exp(-t.nodes[b].params.factor*C),P=r+(d-r)*w;t.values[N]=P}else if(t.nodes[n].mode===MODE_SPRING)for(var T=o?0:(t.values[a]-t.values[a-1])*t.automaton.resolution,M=r,L=t.nodes[n].params.rate,E=t.nodes[n].params.damp,I=1/t.automaton.resolution*t.automaton.length,k=0;l-a+1>k;k++){var y=a+k;T+=(-L*(M-d)-2*T*Math.sqrt(L)*E)*I,M+=T*I,t.values[y]=M}}}},{key:"addNode",value:function(e,t){var n=this,i=n.nodes.filter(function(t){return e<t.time})[0];i||(i={mode:MODE_LINEAR,params:{},mods:{}});var a={time:e,value:t,mode:i.mode,params:i.params,mods:i.mods};return n.nodes.push(a),n.sortNodes(),n.render(),a}},{key:"removeNode",value:function(e){var t=this;return t.nodes.splice(e,1)}},{key:"getValue",value:function(e){var t=this,n="number"==typeof e?e:t.automaton.time;n%=t.automaton.length;var i=n*t.automaton.resolution,a=Math.floor(i),o=i%1,r=t.values[a],m=t.values[a+1];return r+(m-r)*o}}]),e}(),Inspector=function(){var e={},t="",n=0,i=0;e.el=el("div",{position:"fixed",padding:"2px",pointerEvents:"none",font:"500 10px sans-serif",background:"#000",color:"#fff",opacity:"0.0"},document.body),window.addEventListener("mousemove",function(e){n=e.clientX,i=e.clientY}),e.add=function(n,i,a){var o=!1,r=0,m=0,l="number"==typeof a?a:1,d=function(n){if(m++,1===m){o=!0,r++;var a=r;t=i,setTimeout(function(){o&&r===a&&el(e.el,{opacity:"0.5"})},1e3*l)}};n.addEventListener("mouseenter",d);var u=function(t){m--,0===m&&(o=!1,el(e.el,{opacity:"0.0"}))};n.addEventListener("mouseleave",u);var s=function(t){o=!1,el(e.el,{opacity:"0.0"})};return n.addEventListener("mousedown",s),function(){n.removeEventListener("mouseenter",d),n.removeEventListener("mouseleave",u)}};var a=function o(){"function"==typeof t?e.el.innerText=t():e.el.innerText=t;var a=e.el.clientWidth,r=window.innerWidth-n<a+10,m={left:n+(r?-a-10:10)+"px",top:i-15+"px"};el(e.el,m),requestAnimationFrame(o)};return a(),e},AutomatonGUI=function(e){var t={};t.automaton=e;var n=240;t.parent=el("div",{position:"fixed",left:"0",bottom:"0",width:"100%",height:n+"px",background:"#222",color:"#ddd"},document.body);var i=30;t.header=el("div",{position:"absolute",left:"0",top:"0",width:"100%",height:i+"px",background:"#444"},t.parent);var a=120;t.paramList=el("div",{position:"absolute",left:"0",top:i+"px",width:a+"px",height:"calc( 100% - "+i+"px )",background:"#111",overflow:"hidden"},t.parent),t.paramListChildren=[],t.currentParamIndex=0,t.paramListInside=el("div",{position:"absolute",top:"0px",width:"100%"},t.paramList);var o=0;t.paramListInside.addEventListener("wheel",function(e){o=Math.min(Math.max(o+e.deltaY,0),t.paramListInside.clientHeight-(n-i)),el(t.paramListInside,{top:-o+"px"})});var r=200;return t.modMenu=el("div",{position:"absolute",right:"0",top:i+"px",width:r+"px",height:"100%",background:"#333"},t.parent),t.timeline=el("div",{position:"absolute",left:a+"px",top:i+"px",width:"calc( 100% - "+(a+r)+"px )",height:"calc( 100% - "+i+"px )",background:"#222",overflow:"hidden"},t.parent),t.timelineZero=el("div",{position:"absolute",width:"100%",height:"1px",background:"#666"},t.timeline),t.timelineBar=el("div",{position:"absolute",width:"2px",height:"100%",background:"#f82"},t.timeline),t.timelineCanvas=el("canvas",{position:"absolute",width:"100%",height:"100%"},t.timeline),t.timelineContext=t.timelineCanvas.getContext("2d"),t.timelineNodeContainer=el("div",{position:"absolute",width:"100%",height:"100%"},t.timeline),t.timelineNodes=[],t.inspector=Inspector(),t.addParam=function(e,n){var i=el("div",{margin:"2px",padding:"2px 8px",width:"calc( 100% - 4px - 16px )",height:"20px",font:"500 14px sans-serif",background:"#333",cursor:"pointer"},t.paramListInside);i.innerText=e,i.addEventListener("mousedown",function(e){1===e.which&&(t.selectParam(n),t.updateTimeline(!0))});var a=t.automaton.params[e];t.inspector.add(i,function(){return a.getValue().toFixed(3)},.5),t.paramListChildren.push(i)},t.clearParamList=function(){for(;t.paramListInside.firstChild;)t.paramListInside.removeChild(t.paramListInside.firstChild);t.paramListChildren=[]},t.updateParamList=function(){t.clearParamList();var e=t.automaton.getParamNames();e.map(function(e,n){t.addParam(e,n)}),t.selectParam(t.currentParamIndex)},t.timelineMin=0,t.timelineMax=0,t.canvasWidth=0,t.canvasHeight=0,t.mapTime=function(e){return t.canvasWidth*e/t.automaton.length},t.mapValue=function(e){return t.canvasHeight*(.1+.8*((t.timelineMax-e)/(t.timelineMax-t.timelineMin)))},t.rmapTime=function(e){return e/t.canvasWidth*t.automaton.length},t.rmapValue=function(e){return(.1-e/t.canvasHeight)/.8*(t.timelineMax-t.timelineMin)+t.timelineMax},t.timelineNodeRadius=5,t.getCurrentParam=function(){var e=t.paramListChildren[t.currentParamIndex].innerText;return t.automaton.params[e]},t.addTimelineNode=function(e){var n=t.getCurrentParam(),i=n.nodes[e],a=t.mapTime(i.time)-t.timelineNodeRadius,o=t.mapValue(i.value)-t.timelineNodeRadius,r=el("div",{position:"absolute",left:a+"px",top:o+"px",width:2*t.timelineNodeRadius+"px",height:2*t.timelineNodeRadius+"px",borderRadius:t.timelineNodeRadius+"px",background:"#e38",cursor:"pointer"},t.timelineNodeContainer),m=0;r.addEventListener("mousedown",function(){var i=+new Date;300>i-m?(n.removeNode(e),t.updateTimeline(!0),n.render()):t.grabTimelineNode(e),m=i}),t.inspector.add(r,i.time.toFixed(3)+" : "+i.value.toFixed(3),.5),t.timelineNodes.push(r)},t.clearTimelineNodes=function(){for(;t.timelineNodeContainer.firstChild;)t.timelineNodeContainer.removeChild(t.timelineNodeContainer.firstChild);t.timelineNodes=[]},t.grabbingTimelineNode=-1,t.grabTimelineNode=function(e){t.grabbingTimelineNode=e},t.timelineNodeContainer.addEventListener("dblclick",function(e){var n=t.getCurrentParam(),i=t.timeline.getBoundingClientRect();n.addNode(t.rmapTime(e.clientX-i.left),t.rmapValue(e.clientY-i.top)),t.updateTimeline(!0)}),window.addEventListener("mousemove",function(e){if(-1!==t.grabbingTimelineNode){var n=t.getCurrentParam(),i=n.nodes[t.grabbingTimelineNode],a=t.timeline.getBoundingClientRect();0!==t.grabbingTimelineNode&&t.grabbingTimelineNode!==t.timelineNodes.length-1&&(i.time=t.rmapTime(e.clientX-a.left),i.time=Math.min(Math.max(i.time,n.nodes[t.grabbingTimelineNode-1].time+1/t.automaton.resolution),n.nodes[t.grabbingTimelineNode+1].time-1/t.automaton.resolution)),i.value=t.rmapValue(e.clientY-a.top),n.render(),el(t.timelineNodes[t.grabbingTimelineNode],{left:t.mapTime(i.time)-t.timelineNodeRadius+"px",top:t.mapValue(i.value)-t.timelineNodeRadius+"px"})}}),window.addEventListener("mouseup",function(e){if(-1!==t.grabbingTimelineNode){var n=t.getCurrentParam(),i=n.nodes[t.grabbingTimelineNode],a=t.timeline.getBoundingClientRect();0!==t.grabbingTimelineNode&&t.grabbingTimelineNode!==t.timelineNodes.length-1&&(i.time=t.rmapTime(e.clientX-a.left),i.time=Math.min(Math.max(i.time,n.nodes[t.grabbingTimelineNode-1].time+1/t.automaton.resolution),n.nodes[t.grabbingTimelineNode+1].time-1/t.automaton.resolution)),i.value=t.rmapValue(e.clientY-a.top),n.render(),t.grabbingTimelineNode=-1}}),t.updateTimelineRange=function(){var e=t.getCurrentParam();t.timelineMin=0,t.timelineMax=0,e.nodes.map(function(e){t.timelineMin=Math.min(t.timelineMin,e.value),t.timelineMax=Math.max(t.timelineMax,e.value)}),t.timelineMin===t.timelineMax&&(t.timelineMin-=.5,t.timelineMax+=.5)},t.updateTimelineCanvas=function(e){t.timelineContext.clearRect(0,0,t.canvasWidth,t.canvasHeight),t.timelineContext.strokeStyle="#ddd",t.timelineContext.beginPath(),t.timelineContext.moveTo(0,t.mapValue(e.getValue(0)));for(var n=1;n<t.timelineCanvas.width;n++){var i=n/t.timelineCanvas.width*t.automaton.length,a=t.mapValue(e.getValue(i));t.timelineContext.lineTo(n,a)}t.timelineContext.stroke()},t.updateTimeline=function(e){if(t.canvasWidth=window.innerWidth-a-r,t.canvasHeight=n-i,t.timelineCanvas.width=t.canvasWidth,t.timelineCanvas.height=t.canvasHeight,el(t.timelineBar,{left:t.automaton.time/t.automaton.length*t.canvasWidth-1+"px"}),!(t.currentParamIndex<0||t.paramListChildren.length<=t.currentParamIndex)){var o=t.getCurrentParam();e&&(el(t.timelineZero,{top:t.mapValue(0)-.5+"px"}),t.clearTimelineNodes(),o.nodes.map(function(e,n){return t.addTimelineNode(n)})),t.updateTimelineCanvas(o)}},t.selectParam=function(e){0>e||t.paramListChildren.length<=e||(el(t.paramListChildren[t.currentParamIndex],{background:"#333"}),t.currentParamIndex=e,el(t.paramListChildren[t.currentParamIndex],{background:"#555"}))},t.update=function(){t.updateTimeline()},t.resize=function(){t.updateTimeline()},window.addEventListener("resize",t.resize),t.updateParamList(),t.selectParam(0),t.updateTimelineRange(),t.updateTimeline(!0),t},Automaton=function(e){var t={};return t.time=0,t.length=1,t.resolution=1e3,t.params={},t.createParam=function(e){var n=new AutomatonParam(t);return t.params[e]=n,n},t.getParamNames=function(){var e=[];for(var n in t.params)e.push(n);return e=e.sort()},t.createParam("a"),t.createParam("s"),t.createParam("d"),t.createParam("c"),t.createParam("b"),t.createParam("no"),t.createParam("wow"),t.createParam("wowo"),t.createParam("wowo0"),t.createParam("wowo1"),t.createParam("wowa"),t.hasGui=!1,e.gui&&(t.hasGui=!0,t.gui=AutomatonGUI(t),t.gui.updateParamList(),t.gui.selectParam(0)),t.update=function(e){t.time=e%t.length,t.gui.update()},t.auto=function(e,n){return t.params[e]||t.createParam(e),t.params[e].getValue()},t};window.Automaton=Automaton,"undefined"!=typeof module&&(module.exports=Automaton);