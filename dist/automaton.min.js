"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var a=t[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(t,n,a){return n&&e(t.prototype,n),a&&e(t,a),t}}(),el=function(e,t,n){var a=null;a="string"==typeof e?document.createElement(e):e;for(var i in t)a.style[i]=t[i];return n&&n.appendChild(a),a},MODE_LINEAR=0,AutomatonParam=function(){function e(t){_classCallCheck(this,e);var n=this;n.automaton=t,n.values=[];for(var a=0;a<n.automaton.resolution+1;a++)n.values[a]=0;n.nodes=[],n.addNode(0,0),n.addNode(.5,.75),n.addNode(n.automaton.length,1)}return _createClass(e,[{key:"sortNodes",value:function(){var e=this;e.nodes.sort(function(e,t){return e.time-t.time})}},{key:"render",value:function(e){var t=this;if(!(1>e||t.nodes.length<=e)){var n=t.nodes[e-1].time,a=Math.ceil(n*t.automaton.resolution),i=t.nodes[e-1].value,o=t.nodes[e].time,r=Math.floor(o*t.automaton.resolution),l=t.nodes[e].value;if(t.nodes[e].mode===MODE_LINEAR)for(var d=0;r-a+1>d;d++){var u=a+d,m=u/t.automaton.resolution,s=(m-n)/(o-n),c=i+(l-i)*s;t.values[u]=c}}}},{key:"addNode",value:function(e,t){var n=this,a={time:e,value:t,mode:MODE_LINEAR,mods:[]};n.nodes.push(a),n.sortNodes(),n.render(n.nodes.indexOf(a)),n.render(n.nodes.indexOf(a)+1)}},{key:"getValue",value:function(e){var t=this,n="number"==typeof e?e:t.automaton.time;n%=t.automaton.length;var a=n*t.automaton.resolution,i=Math.floor(a),o=a%1,r=t.values[i],l=t.values[i+1];return r+(l-r)*o}}]),e}(),Inspector=function(){var e={},t="",n=0,a=0;e.el=el("div",{position:"fixed",padding:"2px",pointerEvents:"none",font:"500 10px sans-serif",background:"#000",color:"#fff",opacity:"0.0"},document.body),window.addEventListener("mousemove",function(e){n=e.clientX,a=e.clientY}),e.add=function(n,a,i){var o=!1,r=0,l=0,d="number"==typeof i?i:1,u=function(n){if(l++,1===l){o=!0,r++;var i=r;t=a,setTimeout(function(){o&&r===i&&el(e.el,{opacity:"0.8"})},1e3*d)}};n.addEventListener("mouseenter",u);var m=function(t){l--,0===l&&(o=!1,el(e.el,{opacity:"0.0"}))};n.addEventListener("mouseleave",m);var s=function(t){o=!1,el(e.el,{opacity:"0.0"})};return n.addEventListener("mousedown",s),function(){n.removeEventListener("mouseenter",u),n.removeEventListener("mouseleave",m)}};var i=function o(){"function"==typeof t?e.el.innerText=t():e.el.innerText=t;var i=e.el.clientWidth,r=window.innerWidth-n<i+10,l={left:n+(r?-i-10:10)+"px",top:a-15+"px"};el(e.el,l),requestAnimationFrame(o)};return i(),e},AutomatonGUI=function(e){var t={};t.automaton=e;var n=240;t.parent=el("div",{position:"fixed",left:"0",bottom:"0",width:"100%",height:n+"px",background:"#222",color:"#ddd"},document.body);var a=30;t.header=el("div",{position:"absolute",left:"0",top:"0",width:"100%",height:a+"px",background:"#444"},t.parent);var i=120;t.paramList=el("div",{position:"absolute",left:"0",top:a+"px",width:i+"px",height:"100%",background:"#111"},t.parent),t.paramListChildren=[],t.currentParamIndex=0;var o=200;return t.modMenu=el("div",{position:"absolute",right:"0",top:a+"px",width:o+"px",height:"100%",background:"#333"},t.parent),t.timeline=el("div",{position:"absolute",left:i+"px",top:a+"px",width:"calc( 100% - "+(i+o)+"px )",height:"calc( 100% - "+a+"px )",background:"#222",overflow:"hidden"},t.parent),t.timelineCanvas=el("canvas",{position:"absolute",width:"100%",height:"100%"},t.timeline),t.timelineContext=t.timelineCanvas.getContext("2d"),t.timelineNodeContainer=el("div",{position:"absolute",width:"100%",height:"100%"},t.timeline),t.timelineNodes=[],t.inspector=Inspector(),t.addParam=function(e,n){var a=el("div",{margin:"2px",padding:"2px 8px",width:"calc( 100% - 4px - 16px )",height:"20px",font:"500 14px sans-serif",background:"#333",cursor:"pointer"},t.paramList);a.innerText=e,a.addEventListener("mousedown",function(e){1===e.which&&t.selectParam(n)});var i=t.automaton.params[e];t.inspector.add(a,i.getValue().toFixed(3),.5),t.paramListChildren.push(a)},t.clearParamList=function(){for(;t.paramList.firstChild;)t.paramList.removeChild(t.paramList.firstChild);t.paramListChildren=[]},t.updateParamList=function(){t.clearParamList();var e=t.automaton.getParamNames();e.map(function(e,n){t.addParam(e,n)}),t.selectParam(t.currentParamIndex)},t.timelineMin=0,t.timelineMax=0,t.canvasWidth=0,t.canvasHeight=0,t.mapTime=function(e){return t.canvasWidth*e/t.automaton.length},t.mapValue=function(e){return t.canvasHeight*(.1+.8*((t.timelineMax-e)/(t.timelineMax-t.timelineMin)))},t.timelineNodeRadius=5,t.addTimelineNode=function(e,n){var a=t.mapTime(e)-t.timelineNodeRadius,i=t.mapValue(n)-t.timelineNodeRadius,o=el("div",{position:"absolute",left:a+"px",top:i+"px",width:2*t.timelineNodeRadius+"px",height:2*t.timelineNodeRadius+"px",borderRadius:t.timelineNodeRadius+"px",background:"#e38",cursor:"pointer"},t.timelineNodeContainer);t.inspector.add(o,n.toFixed(3),.5),t.timelineNodes.push(o)},t.clearTimelineNodes=function(){for(;t.timelineNodeContainer.firstChild;)t.timelineNodeContainer.removeChild(t.timelineNodeContainer.firstChild);t.timelineNodes=[]},t.updateTimelineRange=function(e){t.timelineMin=0,t.timelineMax=0,e.nodes.map(function(e){t.timelineMin=Math.min(t.timelineMin,e.value),t.timelineMax=Math.max(t.timelineMax,e.value)}),t.timelineMin===t.timelineMax&&(t.timelineMin-=.5,t.timelineMax+=.5)},t.updateTimelineCanvas=function(e){t.timelineContext.clearRect(0,0,t.canvasWidth,t.canvasHeight),t.timelineContext.strokeStyle="#ddd",t.timelineContext.beginPath(),t.timelineContext.moveTo(0,t.mapValue(e.getValue(0)));for(var n=1;n<t.timelineCanvas.width;n++){var a=n/t.timelineCanvas.width*t.automaton.length,i=t.mapValue(e.getValue(a));t.timelineContext.lineTo(n,i),console.log(n,i)}t.timelineContext.stroke()},t.updateTimeline=function(){if(t.canvasWidth=window.innerWidth-i-o,t.canvasHeight=n-a,t.timelineCanvas.width=t.canvasWidth,t.timelineCanvas.height=t.canvasHeight,!(t.currentParamIndex<0||t.paramListChildren.length<=t.currentParamIndex)){var e=t.paramListChildren[t.currentParamIndex].innerText,r=t.automaton.params[e];t.updateTimelineRange(r),t.clearTimelineNodes(),r.nodes.map(function(e){return t.addTimelineNode(e.time,e.value)}),t.updateTimelineCanvas(r)}},t.selectParam=function(e){0>e||t.paramListChildren.length<=e||(el(t.paramListChildren[t.currentParamIndex],{background:"#333"}),t.currentParamIndex=e,el(t.paramListChildren[t.currentParamIndex],{background:"#555"}))},t.resize=function(){t.updateTimeline()},window.addEventListener("resize",t.resize),t.updateParamList(),t.selectParam(0),t.updateTimeline(),t},Automaton=function(e){var t={};return t.time=0,t.length=1,t.resolution=100,t.params={},t.createParam=function(e){var n=new AutomatonParam(t);return t.params[e]=n,n},t.getParamNames=function(){var e=[];for(var n in t.params)e.push(n);return e=e.sort()},t.createParam("a"),t.createParam("s"),t.createParam("d"),t.hasGui=!1,e.gui&&(t.hasGui=!0,t.gui=AutomatonGUI(t),t.gui.updateParamList(),t.gui.selectParam(0)),t.update=function(e){t.time=e%t.length},t.auto=function(e,n){return t.params[e]||t.createParam(e),t.params[e].getValue()},t};window.Automaton=Automaton,"undefined"!=typeof module&&(module.exports=Automaton);